<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{{ app_name }}{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>

    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body class="bg-gray-50 h-full flex flex-col">
    <!-- Navigation Header -->
    <nav
      class="bg-white shadow-sm border-b border-gray-200 px-4 py-3 flex items-center justify-between flex-shrink-0"
    >
      <div class="flex items-center space-x-4">
        <a
          href="{{ url_for('main.index') }}"
          class="flex items-center space-x-2"
        >
          <div
            class="bg-blue-600 text-white px-2 py-1 rounded text-sm font-medium"
          >
            AF
          </div>
          <h1 class="text-xl font-semibold text-gray-900">{{ app_name }}</h1>
        </a>
      </div>

      <!-- Navigation Links -->
      <div class="flex items-center space-x-6">
        {% set current_page = request.endpoint %}
        <a
          href="{{ url_for('main.index') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.index' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Chat
        </a>
        <a
          href="{{ url_for('main.registry') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.registry' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Registry
        </a>
        <a
          href="{{ url_for('main.workflows') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.workflows' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Workflows
        </a>
        <a
          href="{{ url_for('main.dependencies') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.dependencies' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Dependencies
        </a>

        <!-- System Status -->
        <div class="flex items-center space-x-2">
          <div
            id="status-indicator"
            class="w-2 h-2 bg-red-500 rounded-full"
          ></div>
          <span id="status-text" class="text-sm text-gray-500">Connected</span>
        </div>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden min-h-0">
      <!-- Sidebar (only on chat page) -->
      {% if request.endpoint == 'main.index' %}
      <div
        class="w-80 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col"
      >
        <!-- Workflow Status Panel -->
        <div class="p-4 border-b border-gray-200">
          <h3 class="text-sm font-medium text-gray-900 mb-3">
            Workflow Status
          </h3>
          <div id="workflow-status">
            <div class="text-sm text-gray-500" id="workflow-message">
              Real-time execution monitoring
            </div>

            <!-- Active Workflow Display -->
            <div id="active-workflow" class="mt-3 hidden">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs font-medium text-blue-800">ACTIVE</span>
                  <span class="text-xs text-blue-600" id="workflow-time"
                    >0s</span
                  >
                </div>
                <div class="text-sm text-blue-900 mb-2" id="workflow-task">
                  Processing request...
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
                  <div
                    class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                    id="workflow-progress"
                    style="width: 0%"
                  ></div>
                </div>

                <div class="text-xs text-blue-700" id="workflow-step">
                  Initializing...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- System Status Panel -->
        <div class="p-4 border-b border-gray-200">
          <h3 class="text-sm font-medium text-gray-900 mb-3">System Status</h3>
          <div id="system-status">
            <div class="space-y-2 text-sm">
              <div class="flex justify-between items-center"></div>
              <div class="flex justify-between">
                <span>Agents</span>
                <span id="agents-count" class="text-gray-500">4</span>
              </div>
              <div class="flex justify-between">
                <span>Tools</span>
                <span id="tools-count" class="text-gray-500">11</span>
              </div>
              <div class="flex justify-between">
                <span>Health Score</span>
                <span id="health-score" class="text-gray-500">100%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Access Panel -->
        <div class="p-4 flex-1">
          <h3 class="text-sm font-medium text-gray-900 mb-3">Quick Access</h3>
          <div class="space-y-2">
            <a
              href="{{ url_for('main.registry') }}"
              class="block text-sm text-blue-600 hover:text-blue-800"
              >Browse Registry</a
            >
            <a
              href="{{ url_for('main.workflows') }}"
              class="block text-sm text-blue-600 hover:text-blue-800"
              >Workflow History</a
            >
            <a
              href="{{ url_for('main.dependencies') }}"
              class="block text-sm text-blue-600 hover:text-blue-800"
              >Dependencies</a
            >
            <a
              href="{{ url_for('main.help_page') }}"
              class="block text-sm text-blue-600 hover:text-blue-800"
              >Help & Examples</a
            >
            <button
              onclick="location.reload()"
              class="block text-sm text-gray-600 hover:text-gray-800"
            >
              Refresh Status
            </button>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Main Content -->
      <div class="flex-1 overflow-auto min-h-0">
        {% block content %}{% endblock %}
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 px-4 py-2 flex-shrink-0">
      <div class="flex items-center justify-between text-sm text-gray-500">
        <span>Â© 2025 {{ app_name }} v1.0.0 - Multi-Agent AI Orchestration</span>
        <div class="flex items-center space-x-4">
          <a href="#" class="hover:text-gray-700">Help</a>
        </div>
      </div>
    </footer>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Status checking script -->
    <script>
      function updateSystemStatus() {
        fetch('/api/health')
          .then((response) => response.json())
          .then((data) => {
            const isHealthy = data.status === 'healthy';
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const backendStatus = document.getElementById('backend-status');
            const backendStatusFooter = document.getElementById(
              'backend-status-footer'
            );

            if (statusIndicator) {
              statusIndicator.className = `w-2 h-2 rounded-full ${
                isHealthy ? 'bg-green-500' : 'bg-red-500'
              }`;
            }
            if (statusText) {
              statusText.textContent = isHealthy ? 'Connected' : 'Disconnected';
            }
            if (backendStatus) {
              backendStatus.innerHTML = `<div class="w-2 h-2 ${
                isHealthy ? 'bg-green-500' : 'bg-red-500'
              } rounded-full mr-1"></div>${
                isHealthy ? 'Connected' : 'Disconnected'
              }`;
              backendStatus.className = `flex items-center ${
                isHealthy ? 'text-green-600' : 'text-red-600'
              }`;
            }
            if (backendStatusFooter) {
              backendStatusFooter.textContent = `Backend: ${
                isHealthy ? 'Connected' : 'Disconnected'
              }`;
            }

            // Update counts
            if (data.services && data.services.registry) {
              const agentsCount = document.getElementById('agents-count');
              const toolsCount = document.getElementById('tools-count');
              const healthScore = document.getElementById('health-score');

              if (agentsCount)
                agentsCount.textContent =
                  data.services.registry.stats.total_agents || '0';
              if (toolsCount)
                toolsCount.textContent =
                  data.services.registry.stats.total_tools || '0';
              if (healthScore)
                healthScore.textContent = `${
                  data.services.registry.health_score || 0
                }%`;
            }
          })
          .catch((err) => {
            console.error('Failed to fetch system status:', err);
          });
      }

      // Initial status check
      updateSystemStatus();

      // Periodic status updates
      setInterval(updateSystemStatus, 30000);

      // Workflow status updates
      let currentWorkflowId = null;
      let workflowUpdateInterval = null;

      function updateWorkflowStatus() {
        fetch('/api/workflow/status/current')
          .then((response) => response.json())
          .then((data) => {
            const messageEl = document.getElementById('workflow-message');
            const activeWorkflowEl = document.getElementById('active-workflow');

            if (data.status === 'active' && data.current_workflow) {
              // Show active workflow
              if (messageEl) messageEl.style.display = 'none';
              if (activeWorkflowEl) {
                activeWorkflowEl.classList.remove('hidden');

                // Update workflow details
                const workflow = data.current_workflow;
                document.getElementById('workflow-task').textContent =
                  workflow.request.substring(0, 50) + '...';
                document.getElementById('workflow-progress').style.width =
                  workflow.progress + '%';
                document.getElementById(
                  'workflow-step'
                ).textContent = `Processing (${workflow.progress}%)`;

                // Calculate time elapsed
                if (workflow.started_at) {
                  const startTime = new Date(workflow.started_at);
                  const elapsed = Math.floor((new Date() - startTime) / 1000);
                  document.getElementById('workflow-time').textContent =
                    elapsed + 's';
                }
              }

              // Start live updates for this workflow
              if (currentWorkflowId !== workflow.id) {
                currentWorkflowId = workflow.id;
                startLiveWorkflowUpdates(workflow.id);
              }
            } else {
              // Show idle state
              if (messageEl) {
                messageEl.style.display = 'block';
                messageEl.textContent = data.message || 'No active workflows';
              }
              if (activeWorkflowEl) activeWorkflowEl.classList.add('hidden');

              // Stop live updates
              if (workflowUpdateInterval) {
                clearInterval(workflowUpdateInterval);
                workflowUpdateInterval = null;
                currentWorkflowId = null;
              }
            }
          })
          .catch((err) => {
            console.error('Failed to fetch workflow status:', err);
            const messageEl = document.getElementById('workflow-message');
            if (messageEl) messageEl.textContent = 'Status unavailable';
          });
      }

      function startLiveWorkflowUpdates(workflowId) {
        if (workflowUpdateInterval) clearInterval(workflowUpdateInterval);

        workflowUpdateInterval = setInterval(() => {
          fetch(`/api/workflow/${workflowId}/live-status`)
            .then((response) => response.json())
            .then((data) => {
              if (data.status === 'completed' || data.status === 'error') {
                // Workflow finished, refresh main status
                updateWorkflowStatus();
              } else {
                // Update progress
                document.getElementById('workflow-progress').style.width =
                  data.progress + '%';
                document.getElementById('workflow-step').textContent =
                  data.current_step || 'Processing...';
              }
            })
            .catch((err) => console.error('Live update failed:', err));
        }, 1000); // Update every second
      }

      // Start workflow status monitoring
      updateWorkflowStatus();
      setInterval(updateWorkflowStatus, 5000); // Check for new workflows every 5 seconds
    </script>
  </body>
</html>
