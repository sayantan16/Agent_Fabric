<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}{{ app_name }}{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>

    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- Custom CSS -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/custom.css') }}"
    />
  </head>
  <body class="bg-gray-50 h-full flex flex-col">
    <!-- Navigation Header -->
    <nav
      class="bg-white shadow-sm border-b border-gray-200 px-4 py-3 flex items-center justify-between flex-shrink-0"
    >
      <div class="flex items-center space-x-4">
        <a
          href="{{ url_for('main.index') }}"
          class="flex items-center space-x-2"
        >
          <div
            class="bg-blue-600 text-white px-2 py-1 rounded text-sm font-medium"
          >
            AF
          </div>
        </a>
      </div>

      <!-- Navigation Links -->
      <div class="flex items-center space-x-6">
        {% set current_page = request.endpoint %}
        <a
          href="{{ url_for('main.index') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.index' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Chat
        </a>
        <a
          href="{{ url_for('main.registry') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.registry' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Registry
        </a>
        <a
          href="{{ url_for('main.workflows') }}"
          class="{{ 'text-blue-600 font-medium border-b-2 border-blue-600' if current_page == 'main.workflows' else 'text-gray-600 hover:text-gray-800' }}"
        >
          Workflows
        </a>
      </div>
    </nav>

    <!-- Main Content Area -->
    <div class="flex-1 flex overflow-hidden min-h-0">
      <!-- Main Content -->
      <div class="flex-1 overflow-auto min-h-0">
        {% block content %}{% endblock %}
      </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Status checking script -->
    <script>
      function updateSystemStatus() {
        fetch('/api/health')
          .then((response) => response.json())
          .then((data) => {
            const isHealthy = data.status === 'healthy';
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const backendStatus = document.getElementById('backend-status');
            const backendStatusFooter = document.getElementById(
              'backend-status-footer'
            );

            if (statusIndicator) {
              statusIndicator.className = `w-2 h-2 rounded-full ${
                isHealthy ? 'bg-green-500' : 'bg-red-500'
              }`;
            }
            if (statusText) {
              statusText.textContent = isHealthy ? 'Connected' : 'Disconnected';
            }
            if (backendStatus) {
              backendStatus.innerHTML = `<div class="w-2 h-2 ${
                isHealthy ? 'bg-green-500' : 'bg-red-500'
              } rounded-full mr-1"></div>${
                isHealthy ? 'Connected' : 'Disconnected'
              }`;
              backendStatus.className = `flex items-center ${
                isHealthy ? 'text-green-600' : 'text-red-600'
              }`;
            }
            if (backendStatusFooter) {
              backendStatusFooter.textContent = `Backend: ${
                isHealthy ? 'Connected' : 'Disconnected'
              }`;
            }

            // Update counts
            if (data.services && data.services.registry) {
              const agentsCount = document.getElementById('agents-count');
              const toolsCount = document.getElementById('tools-count');
              const healthScore = document.getElementById('health-score');

              if (agentsCount)
                agentsCount.textContent =
                  data.services.registry.stats.total_agents || '0';
              if (toolsCount)
                toolsCount.textContent =
                  data.services.registry.stats.total_tools || '0';
              if (healthScore)
                healthScore.textContent = `${
                  data.services.registry.health_score || 0
                }%`;
            }
          })
          .catch((err) => {
            console.error('Failed to fetch system status:', err);
          });
      }

      // Initial status check
      updateSystemStatus();

      // Periodic status updates
      setInterval(updateSystemStatus, 500000);

      // Workflow status updates
      let currentWorkflowId = null;
      let workflowUpdateInterval = null;

      function updateWorkflowStatus() {
        fetch('/api/workflow/status/current')
          .then((response) => response.json())
          .then((data) => {
            const messageEl = document.getElementById('workflow-message');
            const activeWorkflowEl = document.getElementById('active-workflow');

            if (data.status === 'active' && data.current_workflow) {
              // Show active workflow
              if (messageEl) messageEl.style.display = 'none';
              if (activeWorkflowEl) {
                activeWorkflowEl.classList.remove('hidden');

                // Update workflow details
                const workflow = data.current_workflow;
                document.getElementById('workflow-task').textContent =
                  workflow.request.substring(0, 50) + '...';
                document.getElementById('workflow-progress').style.width =
                  workflow.progress + '%';
                document.getElementById(
                  'workflow-step'
                ).textContent = `Processing (${workflow.progress}%)`;

                // Calculate time elapsed
                if (workflow.started_at) {
                  const startTime = new Date(workflow.started_at);
                  const elapsed = Math.floor((new Date() - startTime) / 1000);
                  document.getElementById('workflow-time').textContent =
                    elapsed + 's';
                }
              }

              // Start live updates for this workflow
              if (currentWorkflowId !== workflow.id) {
                currentWorkflowId = workflow.id;
                startLiveWorkflowUpdates(workflow.id);
              }
            } else {
              // Show idle state
              if (messageEl) {
                messageEl.style.display = 'block';
                messageEl.textContent = data.message || 'No active workflows';
              }
              if (activeWorkflowEl) activeWorkflowEl.classList.add('hidden');

              // Stop live updates
              if (workflowUpdateInterval) {
                clearInterval(workflowUpdateInterval);
                workflowUpdateInterval = null;
                currentWorkflowId = null;
              }
            }
          })
          .catch((err) => {
            console.error('Failed to fetch workflow status:', err);
            const messageEl = document.getElementById('workflow-message');
            if (messageEl) messageEl.textContent = 'Status unavailable';
          });
      }

      function startLiveWorkflowUpdates(workflowId) {
        if (workflowUpdateInterval) clearInterval(workflowUpdateInterval);

        workflowUpdateInterval = setInterval(() => {
          fetch(`/api/workflow/${workflowId}/live-status`)
            .then((response) => response.json())
            .then((data) => {
              if (data.status === 'completed' || data.status === 'error') {
                // Workflow finished, refresh main status
                updateWorkflowStatus();
              } else {
                // Update progress
                document.getElementById('workflow-progress').style.width =
                  data.progress + '%';
                document.getElementById('workflow-step').textContent =
                  data.current_step || 'Processing...';
              }
            })
            .catch((err) => console.error('Live update failed:', err));
        }, 500000); // Update every second
      }

      // Start workflow status monitoring
      updateWorkflowStatus();
      setInterval(updateWorkflowStatus, 500000); // Check for new workflows every 10 seconds
    </script>
  </body>
</html>
