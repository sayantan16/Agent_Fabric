<!-- Workflow Panel Component -->
<div
  id="workflow-panel"
  class="w-80 bg-white border-l border-gray-200 flex flex-col"
  x-data="workflowPanelData()"
  x-init="init()"
>
  <!-- Panel Header -->
  <div class="p-4 border-b border-gray-200">
    <h2 class="text-lg font-semibold text-gray-900">Workflow Status</h2>
    <p class="text-sm text-gray-600">Real-time execution monitoring</p>
  </div>

  <!-- Panel Content -->
  <div class="flex-1 overflow-y-auto">
    <!-- Current Workflow Section -->
    <div x-show="currentWorkflow" class="p-4 border-b border-gray-200">
      <h3 class="text-sm font-medium text-gray-900 mb-3">Active Workflow</h3>

      <div class="bg-gray-50 rounded-lg p-4 space-y-3">
        <!-- Workflow ID and Status -->
        <div class="flex items-center justify-between">
          <span
            class="text-xs text-gray-500"
            x-text="currentWorkflow?.id || 'No ID'"
          ></span>
          <span
            class="px-2 py-1 rounded-full text-xs"
            :class="{
              'bg-yellow-100 text-yellow-800': currentWorkflow?.status === 'processing',
              'bg-green-100 text-green-800': currentWorkflow?.status === 'completed',
              'bg-red-100 text-red-800': currentWorkflow?.status === 'error',
              'bg-gray-100 text-gray-800': !currentWorkflow?.status
            }"
            x-text="currentWorkflow?.status || 'unknown'"
          ></span>
        </div>

        <!-- Request Preview -->
        <div x-show="currentWorkflow?.request">
          <span class="text-sm text-gray-700">Request:</span>
          <div
            class="text-sm font-medium text-gray-900"
            x-text="(currentWorkflow?.request || '').substring(0, 100) + '...'"
          ></div>
        </div>
      </div>
    </div>

    <!-- System Statistics -->
    <div class="p-4 border-b border-gray-200">
      <h3 class="text-sm font-medium text-gray-900 mb-3">System Status</h3>

      <div class="space-y-3">
        <!-- Connection Status -->
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Backend</span>
          <span
            class="px-2 py-1 rounded-full text-xs"
            :class="connected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
            x-text="connected ? 'Connected' : 'Disconnected'"
          ></span>
        </div>

        <!-- Component Counts -->
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Agents</span>
          <span
            class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs"
            x-text="systemStats.agents_count || 0"
          ></span>
        </div>

        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Tools</span>
          <span
            class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs"
            x-text="systemStats.tools_count || 0"
          ></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function workflowPanelData() {
    return {
      // Current workflow state
      currentWorkflow: null,
      connected: false,

      // System statistics
      systemStats: {
        agents_count: 0,
        tools_count: 0,
      },

      // ADD THIS PROPERTY:
      workflowResults: {
        agentsUsed: 0,
        executionTime: 0,
        status: 'Idle',
        componentsCreated: 0,
      },

      // Initialize
      init() {
        this.loadWorkflowStatus();
        this.loadSystemStats();
        this.setupPeriodicRefresh();
      },

      // ADD THIS NEW METHOD HERE:
      updateFromExecution(workflowData) {
        // Update current workflow with execution results
        this.currentWorkflow = {
          id: workflowData.workflow_id,
          request: workflowData.request,
          status: 'completed',
          started_at: new Date().toISOString(),
          timeline: [],
          progress: 100,
        };

        // Update workflow results
        this.workflowResults = {
          agentsUsed: workflowData.agents ? workflowData.agents.length : 0,
          executionTime: workflowData.execution_time || 0,
          status: 'Success',
          componentsCreated: workflowData.components_created || 0,
        };

        // Update system stats if needed
        this.loadSystemStats();
      },

      // Load current workflow status
      async loadWorkflowStatus() {
        try {
          const response = await fetch('/api/workflow/status/current');
          if (response.ok) {
            const data = await response.json();
            this.currentWorkflow = data.current_workflow;
            this.connected = true;
          } else {
            this.connected = false;
          }
        } catch (error) {
          console.log('Failed to fetch workflow status:', error);
          this.connected = false;
          this.currentWorkflow = null;
        }
      },

      // Load system statistics
      async loadSystemStats() {
        try {
          const response = await fetch('/api/health');
          if (response.ok) {
            const data = await response.json();
            this.systemStats = {
              agents_count: data.services?.registry?.stats?.total_agents || 0,
              tools_count: data.services?.registry?.stats?.total_tools || 0,
            };
          }
        } catch (error) {
          console.error('Failed to load system stats:', error);
        }
      },

      // Refresh all stats
      async refreshStats() {
        await Promise.all([this.loadWorkflowStatus(), this.loadSystemStats()]);
      },

      // Setup periodic refresh
      setupPeriodicRefresh() {
        setInterval(() => {
          this.loadWorkflowStatus();
        }, 500000); // Every 30 seconds

        setInterval(() => {
          this.loadSystemStats();
        }, 500000); // Every 30 seconds
      },
    };
  }
</script>
