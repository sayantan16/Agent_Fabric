<!-- flask_app/templates/components/workflow-visualization.html -->

<!-- Workflow Visualization Modal/Overlay -->
<div
  id="workflow-visualization-overlay"
  class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
  x-data="workflowVisualizationData()"
  x-show="isVisible"
  @click.self="hideVisualization()"
>
  <!-- Visualization Panel -->
  <div
    class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden"
    @click.stop
  >
    <!-- Header -->
    <div
      class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50"
    >
      <div>
        <h3 class="text-lg font-semibold text-gray-900">Workflow Execution</h3>
        <p class="text-sm text-gray-600">
          Real-time agent orchestration visualization
        </p>
      </div>
      <button
        @click="hideVisualization()"
        class="text-gray-500 hover:text-gray-700 p-2"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Content -->
    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 140px)">
      <!-- Overall Progress -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-700"
            >Overall Progress</span
          >
          <span
            class="text-sm text-gray-500"
            x-text="Math.round(overallProgress) + '% Complete'"
          ></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div
            class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-500"
            :style="`width: ${overallProgress}%`"
          ></div>
        </div>
      </div>

      <!-- Current Step Display -->
      <div
        x-show="currentStep.name"
        class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500"
      >
        <div class="flex items-center">
          <div
            class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"
          ></div>
          <div>
            <div
              class="font-medium text-blue-900"
              x-text="currentStep.name"
            ></div>
            <div
              class="text-sm text-blue-700"
              x-text="currentStep.description"
            ></div>
          </div>
        </div>
      </div>

      <!-- Workflow Steps -->
      <div class="mb-6">
        <h4 class="text-sm font-medium text-gray-700 mb-3">Execution Steps</h4>
        <div class="space-y-3">
          <template x-for="(step, index) in workflowSteps" :key="step.id">
            <div
              class="flex items-center p-3 rounded-lg transition-all duration-300"
              :class="{
                                 'bg-green-50 border border-green-200': step.status === 'completed',
                                 'bg-blue-50 border border-blue-200': step.status === 'active',
                                 'bg-red-50 border border-red-200': step.status === 'error',
                                 'bg-gray-50 border border-gray-200': step.status === 'pending'
                             }"
            >
              <!-- Step Number/Status -->
              <div
                class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3"
                :class="{
                                     'bg-green-500 text-white': step.status === 'completed',
                                     'bg-blue-500 text-white': step.status === 'active',
                                     'bg-red-500 text-white': step.status === 'error',
                                     'bg-gray-300 text-gray-600': step.status === 'pending'
                                 }"
              >
                <span x-show="step.status === 'completed'">‚úì</span>
                <span x-show="step.status === 'active'">‚óè</span>
                <span x-show="step.status === 'error'">‚úó</span>
                <span
                  x-show="step.status === 'pending'"
                  x-text="index + 1"
                ></span>
              </div>

              <!-- Step Content -->
              <div class="flex-1">
                <div
                  class="font-medium"
                  :class="{
                                         'text-green-900': step.status === 'completed',
                                         'text-blue-900': step.status === 'active',
                                         'text-red-900': step.status === 'error',
                                         'text-gray-700': step.status === 'pending'
                                     }"
                  x-text="step.name"
                ></div>
                <div
                  class="text-sm"
                  :class="{
                                         'text-green-700': step.status === 'completed',
                                         'text-blue-700': step.status === 'active',
                                         'text-red-700': step.status === 'error',
                                         'text-gray-500': step.status === 'pending'
                                     }"
                  x-text="step.description"
                ></div>
                <div
                  x-show="step.executionTime"
                  class="text-xs text-gray-500 mt-1"
                >
                  Execution time:
                  <span x-text="step.executionTime + 's'"></span>
                </div>
              </div>

              <!-- Loading Spinner for Active Step -->
              <div
                x-show="step.status === 'active'"
                class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"
              ></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Agent Creation Panel -->
      <div
        x-show="showCreationPanel"
        class="mb-6 p-4 bg-purple-50 rounded-lg border-l-4 border-purple-500"
      >
        <h4 class="font-medium text-purple-900 mb-2">Dynamic Agent Creation</h4>
        <div class="space-y-2">
          <template x-for="creation in creationSteps" :key="creation.id">
            <div class="flex items-center text-sm">
              <div
                class="w-2 h-2 bg-purple-500 rounded-full mr-2 flex-shrink-0"
              ></div>
              <span class="text-purple-700" x-text="creation.message"></span>
              <div
                x-show="creation.active"
                class="ml-2 animate-spin rounded-full h-3 w-3 border-b-2 border-purple-600"
              ></div>
            </div>
          </template>
        </div>
      </div>

      <!-- Results Summary -->
      <div
        x-show="workflowCompleted && workflowResults"
        class="p-4 bg-green-50 rounded-lg border-l-4 border-green-500"
      >
        <h4 class="font-medium text-green-900 mb-2">Execution Complete</h4>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span class="font-medium text-green-800">Agents Used:</span>
            <span
              class="text-green-700"
              x-text="workflowResults?.agentsUsed || 0"
            ></span>
          </div>
          <div>
            <span class="font-medium text-green-800">Execution Time:</span>
            <span
              class="text-green-700"
              x-text="(workflowResults.executionTime || 0) + 's'"
            ></span>
          </div>
          <div>
            <span class="font-medium text-green-800">Status:</span>
            <span
              class="text-green-700"
              x-text="workflowResults.status || 'Success'"
            ></span>
          </div>
          <div>
            <span class="font-medium text-green-800">Components Created:</span>
            <span
              class="text-green-700"
              x-text="workflowResults?.componentsCreated || 0"
            ></span>
          </div>
        </div>
      </div>

      <!-- Error Details -->
      <div
        x-show="workflowError"
        class="p-4 bg-red-50 rounded-lg border-l-4 border-red-500"
      >
        <h4 class="font-medium text-red-900 mb-2">Execution Error</h4>
        <div class="text-sm text-red-700" x-text="workflowError"></div>
      </div>
    </div>

    <!-- Footer Actions -->
    <div
      class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center"
    >
      <div class="text-sm text-gray-600">
        <span x-show="workflowId"
          >Workflow ID:
          <code class="bg-gray-200 px-1 rounded" x-text="workflowId"></code
        ></span>
      </div>
      <div class="flex space-x-3">
        <button
          x-show="workflowCompleted"
          @click="exportResults()"
          class="btn btn-secondary btn-sm"
        >
          Export Results
        </button>
        <button @click="hideVisualization()" class="btn btn-primary btn-sm">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function workflowVisualizationData() {
    return {
      // Visibility state
      isVisible: false,

      // Workflow data
      workflowId: null,
      workflowData: null,

      // Progress tracking
      overallProgress: 0,
      currentStep: { name: '', description: '' },

      // Workflow steps
      workflowSteps: [],

      // Creation tracking
      showCreationPanel: false,
      creationSteps: [],

      // Completion state
      workflowCompleted: false,
      workflowResults: null,
      workflowError: null,

      // Show visualization
      showVisualization(workflowData) {
        console.log('üîÑ Showing workflow visualization:', workflowData);

        this.isVisible = true;
        this.workflowData = workflowData;
        this.workflowId = workflowData.workflow_id || `wf_${Date.now()}`;

        // Reset state
        this.resetState();

        // Initialize workflow steps
        this.initializeWorkflowSteps(workflowData);

        // Start simulation
        this.simulateWorkflowExecution();
      },

      // Hide visualization
      hideVisualization() {
        this.isVisible = false;
        this.resetState();
      },

      // Reset state
      resetState() {
        this.overallProgress = 0;
        this.currentStep = { name: '', description: '' };
        this.workflowSteps = [];
        this.showCreationPanel = false;
        this.creationSteps = [];
        this.workflowCompleted = false;
        this.workflowResults = null;
        this.workflowError = null;
      },

      // Initialize workflow steps
      initializeWorkflowSteps(workflowData) {
        // Base workflow steps
        this.workflowSteps = [
          {
            id: 'analyze',
            name: 'Analyzing Request',
            description: 'Understanding your request and requirements',
            status: 'pending',
          },
          {
            id: 'plan',
            name: 'Planning Workflow',
            description: 'Selecting optimal agents and execution strategy',
            status: 'pending',
          },
          {
            id: 'validate',
            name: 'Validating Components',
            description: 'Checking agent and tool availability',
            status: 'pending',
          },
          {
            id: 'execute',
            name: 'Executing Agents',
            description: 'Running intelligent agents with your data',
            status: 'pending',
          },
          {
            id: 'synthesize',
            name: 'Synthesizing Results',
            description: 'Combining and formatting outputs',
            status: 'pending',
          },
        ];

        // Add dynamic creation step if needed
        if (
          workflowData.metadata &&
          workflowData.metadata.components_created > 0
        ) {
          this.workflowSteps.splice(3, 0, {
            id: 'create',
            name: 'Creating New Agents',
            description: 'Dynamically generating required capabilities',
            status: 'pending',
          });
        }
      },

      // Simulate workflow execution
      async simulateWorkflowExecution() {
        for (let i = 0; i < this.workflowSteps.length; i++) {
          const step = this.workflowSteps[i];

          // Mark step as active
          step.status = 'active';
          this.currentStep = { name: step.name, description: step.description };
          this.updateProgress();

          // Special handling for different steps
          if (step.id === 'create') {
            this.showAgentCreation();
            await this.sleep(3000);
          } else if (step.id === 'execute') {
            this.showAgentExecution();
            await this.sleep(2500);
          } else {
            await this.sleep(1500);
          }

          // Mark step as completed
          step.status = 'completed';
          step.executionTime = Math.random() * 2 + 0.5; // Random execution time
          this.updateProgress();
        }

        // Mark as completed
        this.workflowCompleted = true;
        this.currentStep = {
          name: 'Workflow Complete',
          description: 'All agents executed successfully',
        };
        this.overallProgress = 100;

        // Set results
        this.workflowResults = {
          agentsUsed: this.workflowData?.workflow?.steps?.length || 0,
          executionTime:
            this.workflowData?.execution_time ||
            (Math.random() * 5 + 2).toFixed(1),
          status: this.workflowData?.status || 'Success',
          componentsCreated:
            this.workflowData?.metadata?.components_created || 0,
        };
      },

      // Update progress
      updateProgress() {
        const completedSteps = this.workflowSteps.filter(
          (step) => step.status === 'completed'
        ).length;
        this.overallProgress =
          (completedSteps / this.workflowSteps.length) * 100;
      },

      // Show agent creation
      showAgentCreation() {
        this.showCreationPanel = true;
        this.creationSteps = [
          { id: 1, message: 'Analyzing capability requirements', active: true },
          {
            id: 2,
            message: 'Generating agent code with Claude',
            active: false,
          },
          { id: 3, message: 'Validating generated code', active: false },
          { id: 4, message: 'Registering new agent', active: false },
        ];

        // Simulate creation steps
        let currentStep = 0;
        const stepInterval = setInterval(() => {
          if (currentStep < this.creationSteps.length) {
            this.creationSteps[currentStep].active = false;
            currentStep++;
            if (currentStep < this.creationSteps.length) {
              this.creationSteps[currentStep].active = true;
            }
          } else {
            clearInterval(stepInterval);
          }
        }, 750);
      },

      // Show agent execution
      showAgentExecution() {
        if (this.workflowData?.workflow?.steps) {
          const agents = this.workflowData.workflow.steps;
          this.currentStep = {
            name: 'Executing Agents',
            description: `Running ${
              agents.length
            } intelligent agents: ${agents.join(', ')}`,
          };
        }
      },

      // Export results
      exportResults() {
        if (this.workflowData) {
          const exportData = {
            workflow_id: this.workflowId,
            exported_at: new Date().toISOString(),
            workflow_data: this.workflowData,
            execution_summary: this.workflowResults,
          };

          const blob = new Blob([JSON.stringify(exportData, null, 2)], {
            type: 'application/json',
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `workflow_${this.workflowId}_results.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      },

      // Utility functions
      sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      },
    };
  }

  // Global workflow visualizer instance for integration
  const workflowVisualizer = {
    showWorkflow: function (workflowData) {
      // Find the Alpine.js component and call its method
      const component = document.querySelector(
        '[x-data*="workflowVisualizationData"]'
      );
      if (component) {
        const alpineData = Alpine.$data(component);
        if (alpineData && alpineData.showVisualization) {
          alpineData.showVisualization(workflowData);
        }
      }
    },

    hideWorkflow: function () {
      const component = document.querySelector(
        '[x-data*="workflowVisualizationData"]'
      );
      if (component) {
        const alpineData = Alpine.$data(component);
        if (alpineData && alpineData.hideVisualization) {
          alpineData.hideVisualization();
        }
      }
    },
  };

  // Make globally available
  window.showWorkflowVisualization = function (workflowData) {
    workflowVisualizer.showWorkflow(workflowData);
  };

  window.hideWorkflowVisualization = function () {
    workflowVisualizer.hideWorkflow();
  };
  // Enhanced workflow visualization
  function initWorkflowVisualization() {
    if (typeof mermaid !== 'undefined') {
      mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        flowchart: {
          useMaxWidth: true,
          htmlLabels: true,
          curve: 'basis',
        },
      });
    }
  }

  // Call on page load
  document.addEventListener('DOMContentLoaded', initWorkflowVisualization);
</script>
