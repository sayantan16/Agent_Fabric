<!-- flask_app/templates/components/chat-container.html - COMPLETE FIXED VERSION -->
<div
  class="flex flex-col h-full bg-white rounded-lg shadow-sm border"
  x-data="chatData()"
  x-init="init()"
>
  <!-- Chat Header -->
  <div class="flex items-center justify-between p-4 border-b border-gray-200">
    <div>
      <h2 class="text-lg font-semibold text-gray-900">AI Assistant</h2>
      <p class="text-sm text-gray-600">
        Multi-agent orchestration powered by Claude and GPT-4
      </p>
    </div>
    <button
      id="clear-chat-btn"
      class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
    >
      Clear Chat
    </button>
  </div>

  <!-- Chat Messages Container -->
  <div
    id="chat-messages"
    class="flex-1 overflow-y-auto space-y-4 p-4 bg-gray-50"
    x-ref="messagesContainer"
  >
    <!-- Welcome Banner (only if no existing messages) -->
    <div
      x-show="!hasExistingMessages"
      class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-4"
    >
      <div class="flex items-start space-x-3">
        <div class="flex-shrink-0">
          <div
            class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"
          >
            <span class="text-white font-bold text-sm">AF</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">
            Welcome to Agentic Fabric! 🚀
          </h3>
          <p class="text-gray-600 mb-3">
            I can help you with complex tasks using intelligent AI agents:
          </p>
          <ul class="text-sm text-gray-600 space-y-1 mb-4">
            <li>
              <strong>Document Analysis:</strong> PDF summaries, data extraction
            </li>
            <li>
              <strong>Data Processing:</strong> CSV analysis, statistical
              reports
            </li>
            <li>
              <strong>Content Extraction:</strong> Emails, URLs, phone numbers
            </li>
            <li>
              <strong>Multi-step Workflows:</strong> Complex orchestrated tasks
            </li>
          </ul>
          <div class="mt-3">
            <button
              @click="insertSampleMessage('Extract all email addresses and URLs from this text: Please contact support@company.com or visit https://company.com')"
              class="text-blue-600 hover:text-blue-800 text-sm underline"
            >
              Try: "Extract emails and URLs"
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Existing Chat History from Flask Session -->
    {% if chat_history %} {% for message in chat_history %}
    <div
      class="flex {{ 'justify-end' if message.type == 'user' else 'justify-start' }} mb-4"
    >
      <div
        class="max-w-[80%] p-4 rounded-lg {{ 'bg-blue-600 text-white' if message.type == 'user' else 'bg-gray-100 text-gray-800' }}"
      >
        <div class="prose max-w-none">{{ message.message|safe }}</div>
        {% if message.metadata %}
        <div
          class="mt-3 p-3 bg-white bg-opacity-20 rounded border-l-4 border-white"
        >
          <div class="text-sm font-medium">Workflow:</div>
          <div class="text-xs mt-1">
            Agents: {{ message.metadata.agents_used|length if
            message.metadata.agents_used else 0 }}<br />
            Time: {{ "%.1f"|format(message.metadata.execution_time or 0) }}s
          </div>
        </div>
        {% endif %}
        <div class="text-xs opacity-50 mt-1">{{ message.timestamp }}</div>
      </div>
    </div>
    {% endfor %} {% endif %}

    <!-- Dynamic Messages (Alpine.js managed) -->
    <template x-for="message in messages" :key="message.id">
      <div
        class="flex mb-4"
        :class="message.type === 'user' ? 'justify-end' : 'justify-start'"
      >
        <div
          class="max-w-[80%] p-4 rounded-lg"
          :class="message.type === 'user' ? 'bg-blue-600 text-white' : 
                   message.type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 
                   'bg-gray-100 text-gray-800'"
        >
          <div class="prose max-w-none">
            <div x-html="formatMessage(message.message)"></div>
          </div>

          <!-- Workflow Info for System Messages -->
          <template x-if="message.type === 'system' && message.metadata">
            <div
              class="mt-3 p-3 bg-white bg-opacity-20 rounded border-l-4 border-white"
            >
              <div class="text-sm font-medium">Workflow:</div>
              <div class="text-xs mt-1">
                <div
                  x-show="message.metadata.agents_used && message.metadata.agents_used.length > 0"
                >
                  <strong>Agents:</strong>
                  <span x-text="message.metadata.agents_used.join(', ')"></span>
                </div>
                <div x-show="message.metadata.execution_time">
                  <strong>Time:</strong>
                  <span x-text="message.metadata.execution_time + 's'"></span>
                </div>
              </div>
            </div>
          </template>

          <!-- Timestamp -->
          <div
            class="text-xs opacity-50 mt-1"
            x-text="formatTimestamp(message.timestamp)"
          ></div>
        </div>
      </div>
    </template>

    <!-- Typing Indicator -->
    <div x-show="isTyping" class="flex justify-start mb-4">
      <div class="bg-gray-100 text-gray-600 p-4 rounded-lg max-w-[80%]">
        <div class="flex items-center">
          <div class="flex space-x-1 mr-3">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
            <div
              class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
              style="animation-delay: 0.1s"
            ></div>
            <div
              class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
              style="animation-delay: 0.2s"
            ></div>
          </div>
          <span x-text="typingMessage"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Input Container -->
  <div class="p-4 border-t border-gray-200 bg-white">
    <!-- Message Input Form -->
    <form id="chat-form" @submit.prevent="sendMessage()" class="space-y-3">
      <div class="flex items-end space-x-3">
        <!-- File Attachment Button -->
        <div class="relative">
          <input
            type="file"
            id="file-upload-input"
            class="hidden"
            multiple
            accept=".txt,.pdf,.csv,.json,.xlsx,.xls,.docx,.jpg,.jpeg,.png"
          />
          <button
            type="button"
            id="file-upload-btn"
            class="p-2 text-gray-500 hover:text-gray-700 transition-colors"
          >
            📎
          </button>
          <!-- File preview area -->
          <div
            id="file-preview"
            class="hidden absolute bottom-12 left-0 bg-white border rounded-lg shadow-lg p-2 w-64"
          >
            <div id="file-list" class="text-sm"></div>
          </div>
        </div>

        <!-- Message Input -->
        <div class="flex-1 relative">
          <textarea
            x-model="currentMessage"
            x-ref="messageInput"
            rows="1"
            class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="Ask me anything... (Ctrl+Enter to send)"
            @input="autoResize($refs.messageInput)"
            @keydown.ctrl.enter.prevent="sendMessage()"
            :disabled="isProcessing"
            style="min-height: 44px; max-height: 120px"
          ></textarea>
        </div>

        <!-- Send Button -->
        <button
          type="submit"
          class="flex-shrink-0 w-10 h-10 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center transition-colors disabled:opacity-50"
          :disabled="isProcessing || (!currentMessage.trim() && !(window.selectedFiles && window.selectedFiles.length))"
        >
          <svg
            x-show="!isProcessing"
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
            ></path>
          </svg>
          <svg
            x-show="isProcessing"
            class="w-5 h-5 animate-spin"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Settings -->
      <div class="flex items-center justify-between text-sm">
        <div class="flex items-center space-x-4">
          <label class="flex items-center">
            <input
              type="checkbox"
              x-model="settings.auto_create"
              class="mr-2"
            />
            <span class="text-gray-600">Auto-create missing agents</span>
          </label>
          <select
            x-model="settings.workflow_type"
            class="text-sm border border-gray-300 rounded px-2 py-1"
          >
            <option value="sequential">Sequential</option>
            <option value="parallel">Parallel</option>
          </select>
        </div>
      </div>
    </form>

    <!-- Help Text -->
    <div class="mt-2 text-xs text-gray-500">
      💡 Try: "Extract emails from text" or "Analyze this data"
    </div>
  </div>
</div>

<script>
  function chatData() {
    return {
      // Chat State
      messages: [],
      currentMessage: '',
      isProcessing: false,
      isTyping: false,
      typingMessage: 'AI is thinking...',

      // Settings
      settings: {
        auto_create: true,
        workflow_type: 'sequential',
      },

      hasExistingMessages: {{ 'true' if chat_history else 'false' }},

      init() {
        console.log('Chat system initialized');
      },

      // ⬇⬇ REPLACE THIS WHOLE METHOD ⬇⬇
      async sendMessage() {
        if (this.isProcessing) return;

        const fileInput = document.getElementById('file-upload-input');
        const filesArr = fileInput?.files ? Array.from(fileInput.files) : [];
        const message = (this.currentMessage || '').trim();

        // Block only when both message AND files are empty
        if (!message && filesArr.length === 0) return;

        // Clear the textarea immediately for snappy UX
        this.currentMessage = '';

        // Show user's message bubble (or a placeholder if files-only)
        const userBubble = message || `${filesArr.length} file${filesArr.length > 1 ? 's' : ''} attached`;
        this.addMessage(userBubble, 'user');
        this.scrollToBottom();

        // Typing/processing state
        this.isTyping = true;
        this.isProcessing = true;

        try {
          // 1) Upload files (if any)
          let uploadedFiles = [];
          if (filesArr.length > 0) {
            const fd = new FormData();
            for (const f of filesArr) fd.append('files', f);

            const uploadResp = await fetch('/api/upload', {
              method: 'POST',
              body: fd
            });
            if (!uploadResp.ok) throw new Error(`Upload failed: ${uploadResp.status}`);
            const uploadJson = await uploadResp.json();
            uploadedFiles = Array.isArray(uploadJson.files) ? uploadJson.files : [];
          }

          // 2) Send chat message with file references + settings
          const resp = await fetch('/api/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              files: uploadedFiles,
              settings: this.settings
            })
          });
          const data = await resp.json();

          // ADD THIS DEBUG LINE:
          console.log('🔍 Backend response:', data);

          if (data.status === 'success') {
            this.addMessage(data.response, 'system', data.metadata, data.workflow_id);
          } else {
            this.addMessage(`Error: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (err) {
          console.error('Error sending message:', err);
          this.addMessage(`Error: ${err.message}`, 'error');
        } finally {
          this.isTyping = false;
          this.isProcessing = false;
          this.scrollToBottom();

          // 3) Reset file UI (preview, button color, input value)
          if (typeof window.resetFileSelection === 'function') {
            window.resetFileSelection();
          } else {
            // Fallback cleanup (in case initializeFileUpload hasn't run yet)
            if (fileInput) fileInput.value = '';
            const preview = document.getElementById('file-preview');
            if (preview) preview.classList.add('hidden');
            const uploadBtn = document.getElementById('file-upload-btn');
            if (uploadBtn) uploadBtn.classList.remove('text-blue-600');
          }
        }
      },
      // ⬆⬆ REPLACE THIS WHOLE METHOD ⬆⬆

      addMessage(content, type = 'system', metadata = null, workflowId = null) {
        const message = {
          id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          message: content,
          type: type,
          timestamp: new Date().toISOString(),
          metadata: metadata,
          workflow_id: workflowId,
        };
        this.messages.push(message);
        this.$nextTick(() => this.scrollToBottom());
      },

      insertSampleMessage(text) {
        this.currentMessage = text;
        this.$refs.messageInput.focus();
        this.autoResize(this.$refs.messageInput);
      },

      scrollToBottom() {
        this.$nextTick(() => {
          const container = this.$refs.messagesContainer;
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        });
      },

      autoResize(textarea) {
        textarea.style.height = 'auto';
        const maxHeight = 120;
        textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
      },

      formatMessage(message) {
        return message
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/\n/g, '<br>')
          .replace(/•/g, '&bull;')
          .replace(/📧/g, '📧')
          .replace(/🔗/g, '🔗');
      },

      formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
      },
    };
  }
</script>
