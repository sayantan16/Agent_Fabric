<!-- flask_app/templates/components/chat-container.html - COMPLETE FIXED VERSION -->
<div
  class="flex flex-col h-full bg-white rounded-lg shadow-sm border"
  x-data="chatData()"
  x-init="init()"
>
  <!-- Chat Header -->
  <div class="flex items-center justify-between p-4 border-b border-gray-200">
    <div>
      <h2 class="text-lg font-semibold text-gray-900">AI Assistant</h2>
      <p class="text-sm text-gray-600">
        Multi-agent orchestration powered by Claude and GPT-4
      </p>
    </div>
    <button
      id="clear-chat-btn"
      class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
    >
      Clear Chat
    </button>
  </div>

  <!-- Chat Messages Container - IMPROVED VERSION -->
  <div
    id="chat-messages"
    class="flex-1 overflow-y-auto p-6 space-y-6 bg-gray-50"
    x-ref="messagesContainer"
  >
    <!-- Welcome Banner -->
    <div
      x-show="!hasExistingMessages"
      class="bg-gradient-to-br from-blue-50 to-indigo-100 border border-blue-200 rounded-xl p-6 shadow-sm"
    >
      <div class="flex items-start space-x-4">
        <div class="flex-shrink-0">
          <div
            class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-lg"
          >
            <span class="text-white font-bold text-lg">AF</span>
          </div>
        </div>
        <div class="flex-1">
          <h3 class="text-xl font-semibold text-gray-800 mb-3">
            Welcome to Agentic Fabric!
          </h3>
          <p class="text-gray-600 mb-4 leading-relaxed">
            I orchestrate intelligent AI agents to handle complex tasks through
            natural conversation.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
            <div class="bg-white bg-opacity-60 rounded-lg p-3">
              <div class="font-medium text-gray-800 mb-1">
                Document Analysis
              </div>
              <div class="text-sm text-gray-600">
                PDF summaries, data extraction
              </div>
            </div>
            <div class="bg-white bg-opacity-60 rounded-lg p-3">
              <div class="font-medium text-gray-800 mb-1">Data Processing</div>
              <div class="text-sm text-gray-600">
                CSV analysis, statistical reports
              </div>
            </div>
            <div class="bg-white bg-opacity-60 rounded-lg p-3">
              <div class="font-medium text-gray-800 mb-1">
                Content Extraction
              </div>
              <div class="text-sm text-gray-600">
                Emails, URLs, phone numbers
              </div>
            </div>
            <div class="bg-white bg-opacity-60 rounded-lg p-3">
              <div class="font-medium text-gray-800 mb-1">
                Multi-step Workflows
              </div>
              <div class="text-sm text-gray-600">
                Complex orchestrated tasks
              </div>
            </div>
          </div>

          <button
            @click="insertSampleMessage('Extract all email addresses and URLs from this text: Contact support@company.com or visit https://example.com')"
            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
          >
            Try Sample Request
          </button>
        </div>
      </div>
    </div>

    <!-- Existing Chat History from Flask Session -->
    {% if chat_history %} {% for message in chat_history %}
    <div
      class="flex {{ 'justify-end' if message.type == 'user' else 'justify-start' }}"
    >
      <div
        class="flex max-w-[85%] {{ 'flex-row-reverse' if message.type == 'user' else 'flex-row' }} items-end space-x-3"
      >
        <!-- Avatar -->
        <div
          class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center {{ 'bg-blue-600' if message.type == 'user' else 'bg-gray-600' }}"
        >
          <span class="text-white text-sm font-medium">
            {{ 'You' if message.type == 'user' else 'AI' }}
          </span>
        </div>

        <!-- Message Bubble -->
        <div class="flex-1">
          <div
            class="{{
          'bg-blue-600 text-white rounded-2xl rounded-br-md' if message.type == 'user' 
          else 'bg-white text-gray-800 rounded-2xl rounded-bl-md border border-gray-200 shadow-sm'
        }} px-4 py-3"
          >
            <div
              class="prose max-w-none {{ 'prose-invert' if message.type == 'user' else '' }}"
            >
              {{ message.message|safe }}
            </div>

            <!-- Workflow Info for System Messages -->
            {% if message.metadata and message.type == 'system' %}
            <div class="mt-3 pt-3 border-t border-gray-200 border-opacity-20">
              <div class="flex items-center justify-between text-xs opacity-75">
                <div class="flex items-center space-x-4">
                  {% if message.metadata.agents_used %}
                  <span>Agents: {{ message.metadata.agents_used|length }}</span>
                  {% endif %} {% if message.metadata.execution_time %}
                  <span
                    >{{ "%.1f"|format(message.metadata.execution_time) }}s</span
                  >
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Timestamp -->
          <div
            class="mt-1 text-xs text-gray-500 {{ 'text-right' if message.type == 'user' else 'text-left' }}"
          >
            {{ message.timestamp }}
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% endif %}

    <!-- Dynamic Messages (Alpine.js managed) -->
    <template x-for="message in messages" :key="message.id">
      <div
        class="flex"
        :class="message.type === 'user' ? 'justify-end' : 'justify-start'"
      >
        <div
          class="flex max-w-[85%] items-end space-x-3"
          :class="message.type === 'user' ? 'flex-row-reverse space-x-reverse' : 'flex-row'"
        >
          <!-- Avatar -->
          <div
            class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
            :class="message.type === 'user' ? 'bg-blue-600' : 
                     message.type === 'error' ? 'bg-red-500' : 'bg-gray-600'"
          >
            <span
              class="text-white text-sm font-medium"
              x-text="message.type === 'user' ? 'You' : 'AI'"
            ></span>
          </div>

          <!-- Message Bubble -->
          <div class="flex-1">
            <div
              class="px-4 py-3"
              :class="message.type === 'user' ? 'bg-blue-600 text-white rounded-2xl rounded-br-md' : 
                       message.type === 'error' ? 'bg-red-50 text-red-800 rounded-2xl rounded-bl-md border border-red-200' : 
                       'bg-white text-gray-800 rounded-2xl rounded-bl-md border border-gray-200 shadow-sm'"
            >
              <div
                class="prose max-w-none"
                :class="message.type === 'user' ? 'prose-invert' : ''"
              >
                <div x-html="formatMessage(message.message)"></div>
                <!-- NEW: Add pipeline info for system messages -->
                <template
                  x-if="message.type === 'system' && message.metadata && message.metadata.pipeline_info"
                >
                  <div
                    x-html="renderPipelineInfo(message.metadata.pipeline_info)"
                  ></div>
                </template>
              </div>

              <!-- Workflow Info for System Messages -->
              <template x-if="message.type === 'system' && message.metadata">
                <div
                  class="mt-3 pt-3 border-t border-gray-200 border-opacity-20"
                >
                  <div
                    class="flex items-center justify-between text-xs opacity-75"
                  >
                    <div class="flex items-center space-x-4">
                      <template
                        x-if="message.metadata.agents_used && message.metadata.agents_used.length > 0"
                      >
                        <span
                          x-text="'Agents: ' + message.metadata.agents_used.length"
                        ></span>
                      </template>
                      <template x-if="message.metadata.execution_time">
                        <span
                          x-text="message.metadata.execution_time + 's'"
                        ></span>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- Timestamp -->
            <div
              class="mt-1 text-xs text-gray-500"
              :class="message.type === 'user' ? 'text-right' : 'text-left'"
              x-text="formatTimestamp(message.timestamp)"
            ></div>
          </div>
        </div>
      </div>
    </template>

    <!-- Typing Indicator -->
    <div x-show="isTyping" class="flex justify-start">
      <div class="flex items-end space-x-3 max-w-[85%]">
        <!-- AI Avatar -->
        <div
          class="flex-shrink-0 w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center"
        >
          <span class="text-white text-sm font-medium">AI</span>
        </div>

        <!-- Typing Bubble -->
        <div
          class="bg-white border border-gray-200 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm"
        >
          <div class="flex items-center space-x-2">
            <div class="flex space-x-1">
              <div
                class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
              ></div>
              <div
                class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                style="animation-delay: 0.1s"
              ></div>
              <div
                class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"
                style="animation-delay: 0.2s"
              ></div>
            </div>
            <span class="text-gray-500 text-sm" x-text="typingMessage"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Input Container -->
  <div class="p-4 border-t border-gray-200 bg-white">
    <!-- Message Input Form -->
    <form id="chat-form" @submit.prevent="sendMessage()" class="space-y-3">
      <div class="flex items-end space-x-3">
        <!-- File Attachment Button -->
        <div class="relative">
          <input
            type="file"
            id="file-upload-input"
            class="hidden"
            multiple
            accept=".txt,.pdf,.csv,.json,.xlsx,.xls,.docx,.jpg,.jpeg,.png"
          />
          <button
            type="button"
            id="file-upload-btn"
            class="p-2 text-gray-500 hover:text-gray-700 transition-colors"
          >
            ðŸ“Ž
          </button>
          <!-- File preview area -->
          <div
            id="file-preview"
            class="hidden absolute bottom-12 left-0 bg-white border rounded-lg shadow-lg p-2 w-64"
          >
            <div id="file-list" class="text-sm"></div>
          </div>
        </div>

        <!-- Message Input -->
        <div class="flex-1 relative">
          <textarea
            x-model="currentMessage"
            x-ref="messageInput"
            rows="1"
            class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="Ask me anything... (Ctrl+Enter to send)"
            @input="autoResize($refs.messageInput)"
            @keydown.ctrl.enter.prevent="sendMessage()"
            :disabled="isProcessing"
            style="min-height: 44px; max-height: 120px"
          ></textarea>
        </div>

        <!-- Send Button -->
        <button
          type="submit"
          class="flex-shrink-0 w-10 h-10 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center justify-center transition-colors disabled:opacity-50"
          :disabled="isProcessing || (!currentMessage.trim() && !(window.selectedFiles && window.selectedFiles.length))"
        >
          <svg
            x-show="!isProcessing"
            class="w-5 h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
            ></path>
          </svg>
          <svg
            x-show="isProcessing"
            class="w-5 h-5 animate-spin"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Settings -->
      <div class="flex items-center justify-between text-sm">
        <div class="flex items-center space-x-4">
          <label class="flex items-center">
            <input
              type="checkbox"
              x-model="settings.auto_create"
              class="mr-2"
            />
            <span class="text-gray-600">Auto-create missing agents</span>
          </label>
          <select
            x-model="settings.workflow_type"
            class="text-sm border border-gray-300 rounded px-2 py-1"
          >
            <option value="sequential">Sequential</option>
            <option value="parallel">Parallel</option>
          </select>
        </div>
      </div>
    </form>

    <!-- Help Text -->
    <div class="mt-2 text-xs text-gray-500">
      ðŸ’¡ Try: "Extract emails from text" or "Analyze this data"
    </div>
  </div>
</div>

<script>
  function chatData() {
    return {
      // Chat State
      messages: [],
      currentMessage: '',
      isProcessing: false,
      isTyping: false,
      typingMessage: 'AI is thinking...',

      // Settings
      settings: {
        auto_create: true,
        workflow_type: 'sequential',
      },

      hasExistingMessages: {{ 'true' if chat_history else 'false' }},

      init() {
        console.log('Chat system initialized');
      },

      // â¬‡â¬‡ REPLACE THIS WHOLE METHOD â¬‡â¬‡
      async sendMessage() {
        if (this.isProcessing) return;

        const fileInput = document.getElementById('file-upload-input');
        const filesArr = fileInput?.files ? Array.from(fileInput.files) : [];
        const message = (this.currentMessage || '').trim();

        // Block only when both message AND files are empty
        if (!message && filesArr.length === 0) return;

        // Clear the textarea immediately for snappy UX
        this.currentMessage = '';

        // Show user's message bubble (or a placeholder if files-only)
        const userBubble = message || `${filesArr.length} file${filesArr.length > 1 ? 's' : ''} attached`;
        this.addMessage(userBubble, 'user');
        this.scrollToBottom();

        // Typing/processing state
        this.isTyping = true;
        this.isProcessing = true;

        try {
          // 1) Upload files (if any)
          let uploadedFiles = [];
          if (filesArr.length > 0) {
            const fd = new FormData();
            for (const f of filesArr) fd.append('files', f);

            const uploadResp = await fetch('/api/upload', {
              method: 'POST',
              body: fd
            });
            if (!uploadResp.ok) throw new Error(`Upload failed: ${uploadResp.status}`);
            const uploadJson = await uploadResp.json();
            uploadedFiles = Array.isArray(uploadJson.files) ? uploadJson.files : [];
          }

          // 2) Send chat message with file references + settings
          const resp = await fetch('/api/chat/message', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message,
              files: uploadedFiles,
              settings: this.settings
            })
          });
          const data = await resp.json();

          // ADD THIS DEBUG LINE:
          console.log('ðŸ” Backend response:', data);

          if (data.status === 'success') {
              this.addMessage(data.response, 'system', data.metadata, data.workflow_id);
          } else {
              this.addMessage(`Error: ${data.error || 'Unknown error'}`, 'error');
          }
        } catch (err) {
          console.error('Error sending message:', err);
          this.addMessage(`Error: ${err.message}`, 'error');
        } finally {
          this.isTyping = false;
          this.isProcessing = false;
          this.scrollToBottom();

          // 3) Reset file UI (preview, button color, input value)
          if (typeof window.resetFileSelection === 'function') {
            window.resetFileSelection();
          } else {
            // Fallback cleanup (in case initializeFileUpload hasn't run yet)
            if (fileInput) fileInput.value = '';
            const preview = document.getElementById('file-preview');
            if (preview) preview.classList.add('hidden');
            const uploadBtn = document.getElementById('file-upload-btn');
            if (uploadBtn) uploadBtn.classList.remove('text-blue-600');
          }
        }
      },
      // â¬†â¬† REPLACE THIS WHOLE METHOD â¬†â¬†

      addMessage(content, type = 'system', metadata = null, workflowId = null) {
        const message = {
          id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          message: content,
          type: type,
          timestamp: new Date().toISOString(),
          metadata: metadata,
          workflow_id: workflowId,
        };
        this.messages.push(message);
        this.$nextTick(() => this.scrollToBottom());
      },

      insertSampleMessage(text) {
        this.currentMessage = text;
        this.$refs.messageInput.focus();
        this.autoResize(this.$refs.messageInput);
      },

      scrollToBottom() {
        this.$nextTick(() => {
          const container = this.$refs.messagesContainer;
          if (container) {
            container.scrollTop = container.scrollHeight;
          }
        });
      },

      autoResize(textarea) {
        textarea.style.height = 'auto';
        const maxHeight = 120;
        textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
      },

      formatMessage(message) {
        let html = message
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/\n/g, '<br>')
          .replace(/â€¢/g, '&bull;')
          .replace(/ðŸ“§/g, 'ðŸ“§')
          .replace(/ðŸ”—/g, 'ðŸ”—');

        return html;
      },

      // ADD this new method after formatMessage:
      renderPipelineInfo(pipelineInfo) {
        if (!pipelineInfo || pipelineInfo.type === 'simple') return '';

        let html = `
          <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex justify-between items-center mb-2">
              <h6 class="text-sm font-semibold text-blue-800 mb-0">
                <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
                ${pipelineInfo.type === 'pipeline' ? 'Multi-Step Pipeline' : 'Complex Pipeline'}
              </h6>
              <span class="text-xs px-2 py-1 rounded-full ${this.getStatusBadgeClass(pipelineInfo.performance_grade)}">
                ${pipelineInfo.performance_grade || 'unknown'}
              </span>
            </div>
        `;

        if (pipelineInfo.steps && pipelineInfo.steps.length > 0) {
          html += '<div class="space-y-1">';
          html += '<div class="text-xs text-blue-700 font-medium">Execution Steps:</div>';

          pipelineInfo.steps.forEach((step, index) => {
            const isCompleted = index < (pipelineInfo.steps_completed || 0);
            const icon = isCompleted ?
              '<svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>' :
              '<svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8"/></svg>';

            html += `
              <div class="flex items-center space-x-2">
                ${icon}
                <span class="text-xs ${isCompleted ? 'text-gray-800' : 'text-gray-500'}">${step}</span>
              </div>
            `;
          });

          html += `
            <div class="mt-2 pt-2 border-t border-blue-200 text-xs text-blue-600 space-x-3">
              <span>Progress: ${pipelineInfo.steps_completed || 0}/${pipelineInfo.total_steps || 0}</span>
              <span>Time: ${(pipelineInfo.execution_time || 0).toFixed(1)}s</span>
              ${pipelineInfo.components_created > 0 ? `<span class="text-green-600">Created: ${pipelineInfo.components_created} components</span>` : ''}
            </div>
          `;
          html += '</div>';
        }

        html += '</div>';
        return html;
      },

      // ADD this helper method:
      getStatusBadgeClass(grade) {
        switch(grade) {
          case 'excellent': return 'bg-green-100 text-green-800';
          case 'good': return 'bg-blue-100 text-blue-800';
          case 'acceptable': return 'bg-yellow-100 text-yellow-800';
          case 'needs_improvement': return 'bg-red-100 text-red-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      },

      formatTimestamp(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
      },
    };
  }
</script>
